<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PM Tính Học Phí - ver 2.3</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@300;400;500;600;700&display=swap');
        body {
            font-family: 'Be Vietnam Pro', sans-serif;
        }
        .fee-card {
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .fee-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }
        .checkbox-container:hover input ~ .checkmark {
            background-color: #e2e8f0;
        }
        .checkbox-container input:checked ~ .checkmark {
            background-color: #3b82f6;
            border-color: #3b82f6;
        }
        .checkmark:after {
            content: "";
            position: absolute;
            display: none;
        }
        .checkbox-container input:checked ~ .checkmark:after {
            display: block;
        }
        .checkbox-container .checkmark:after {
            left: 6px;
            top: 2px;
            width: 5px;
            height: 10px;
            border: solid white;
            border-width: 0 3px 3px 0;
            transform: rotate(45deg);
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1000;
            overflow-y: auto;
        }
        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 800px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }
        .receipt-row {
            display: grid;
            grid-template-columns: 40% 20% 20% 20%;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }
        .receipt-header {
            font-weight: bold;
            border-bottom: 1px solid #ddd;
            padding-bottom: 5px;
        }
        .session-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 8px;
            padding: 10px;
            background-color: #f8fafc;
            border-radius: 6px;
            margin-top: 10px;
        }
        .session-item {
            padding: 6px;
            background-color: white;
            border: 1px solid #e2e8f0;
            border-radius: 4px;
            text-align: center;
        }
        .notes-section {
            margin-top: 10px;
            padding: 10px;
            background-color: #fffbeb;
            border-left: 4px solid #f59e0b;
            border-radius: 4px;
        }
        @media print {
            .no-print {
                display: none !important;
            }
            body * {
                visibility: hidden;
            }
            #printable-receipt, #printable-receipt * {
                visibility: visible;
            }
            #printable-receipt {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }
            .modal-content {
                box-shadow: none;
                margin: 0;
                padding: 0;
                width: 100%;
                max-width: 100%;
            }
        }
        
    </style>
</head>
<body class="bg-gray-50">
    <div class="container mx-auto px-4 py-8 max-w-6xl">
        <header class="text-center mb-8">
            <h1 class="text-3xl font-bold text-blue-600 mb-2">PHẦN MỀM TÍNH HỌC PHÍ</h1>
            <p class="text-gray-600">Phiên bản 2.3 - được phát triển bởi Lâm Chí Phương</p>
            <p class="text-gray-600">Email: lamchiphuong.work@gmail.com</p>
        </header>
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Student Input Section -->
            <div class="bg-white rounded-xl shadow-md p-6 lg:col-span-1">
                <h2 class="text-xl font-semibold mb-4 text-gray-800">Thông tin học viên</h2>
             
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1" for="studentName">Tên học viên</label>
                    <input type="text" id="studentName" placeholder="Nhập tên học viên" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1" for="studentClass">Lớp</label>
                    <input type="text" id="studentClass" placeholder="Nhập lớp học" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1" for="feeRate">Đơn giá học phí (đồng/buổi)</label>
                    <input type="number" id="feeRate" placeholder="Nhập đơn giá" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" value="100000" step="1000" min="0">
                </div>
                <div class="mb-4">
                    <button id="addStudentBtn" class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 transition duration-200">
                        Thêm học viên
                    </button>
                </div>
                <div class="flex space-x-2">
                    <button id="loadFromFileBtn" class="w-1/2 bg-gray-300 text-gray-800 py-2 px-4 rounded-md hover:bg-gray-400 transition duration-200">
                        Mở file
                    </button>
                    <button id="saveToFileBtn" class="w-1/2 bg-blue-500 text-white py-2 px-4 rounded-md hover:bg-blue-600 transition duration-200">
                        Lưu file
                    </button>
                </div>
                <input type="file" id="fileInput" accept=".json" class="hidden">
            </div>
            <!-- Calendar Section -->
            <div class="bg-white rounded-xl shadow-md p-6 lg:col-span-2">
                <h2 class="text-xl font-semibold mb-4 text-gray-800">Điểm danh buổi học</h2>
             
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Chọn học viên</label>
                    <select id="studentSelect" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">-- Chọn học viên --</option>
                    </select>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Chọn buổi học</label>
                    <div id="calendarGrid" class="grid grid-cols-7 gap-2">
                        <!-- Calendar days will be added here by JavaScript -->
                    </div>
                </div>
                <div class="flex justify-between">
                    <button id="prevMonthBtn" class="bg-gray-200 text-gray-700 py-2 px-4 rounded-md hover:bg-gray-300 transition duration-200">
                        Tháng trước
                    </button>
                    <h3 id="currentMonthYear" class="text-lg font-semibold text-gray-700"></h3>
                    <button id="nextMonthBtn" class="bg-gray-200 text-gray-700 py-2 px-4 rounded-md hover:bg-gray-300 transition duration-200">
                        Tháng sau
                    </button>
                </div>
            </div>
        </div>
        <!-- Student List and Fee Calculation -->
        <div class="mt-8">
            <h2 class="text-xl font-semibold mb-4 text-gray-800">Danh sách học viên và học phí</h2>
         
            <div id="studentsList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <!-- Student cards will be added here by JavaScript -->
            </div>
            <!-- Summary Section -->
            <div class="mt-6 bg-white rounded-xl shadow-md p-6">
                <div class="flex justify-between items-center">
                    <div>
                        <h3 class="text-lg font-semibold text-gray-800">Tổng kết học phí</h3>
                        <p class="text-gray-600">Tổng số học viên: <span id="totalStudents" class="font-medium">0</span></p>
                    </div>
                    <div class="text-right">
                        <p class="text-lg font-semibold text-blue-600">Tổng học phí: <span id="totalFees">0</span> đ</p>
                    </div>
                </div>
                <div class="mt-4 flex justify-end space-x-3">
                    <button id="clearAllBtn" class="bg-red-500 text-white py-2 px-4 rounded-md hover:bg-red-600 transition duration-200">
                        Xóa tất cả
                    </button>
                    <button id="showReceiptBtn" class="bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700 transition duration-200">
                        Xem phiếu học phí
                    </button>
                </div>
            </div>
        </div>
    </div>
    <!-- Edit Discount Modal -->
    <div id="editDiscountModal" class="modal">
        <div class="modal-content max-w-md">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-800">Chỉnh sửa giảm giá</h2>
                <button id="closeEditDiscountBtn" class="text-gray-500 hover:text-gray-700">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-1" for="editDiscountInput">Giảm giá (%)</label>
                <input type="number" id="editDiscountInput" min="0" max="100" step="0.1" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Nhập % giảm giá">
            </div>
            <div class="flex justify-end space-x-3">
                <button id="cancelEditDiscountBtn" class="bg-gray-300 text-gray-800 py-2 px-4 rounded-md hover:bg-gray-400 transition duration-200">
                    Hủy
                </button>
                <button id="saveEditDiscountBtn" class="bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 transition duration-200">
                    Lưu
                </button>
            </div>
        </div>
    </div>
    <!-- Edit Notes Modal -->
    <div id="editNotesModal" class="modal">
        <div class="modal-content max-w-md">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-800">Chỉnh sửa ghi chú</h2>
                <button id="closeEditNotesBtn" class="text-gray-500 hover:text-gray-700">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-1" for="editNotesTextarea">Ghi chú cho học viên</label>
                <textarea id="editNotesTextarea" rows="4" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Nhập ghi chú..."></textarea>
            </div>
            <div class="flex justify-end space-x-3">
                <button id="cancelEditNotesBtn" class="bg-gray-300 text-gray-800 py-2 px-4 rounded-md hover:bg-gray-400 transition duration-200">
                    Hủy
                </button>
                <button id="saveEditNotesBtn" class="bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 transition duration-200">
                    Lưu
                </button>
            </div>
        </div>
    </div>
    <!-- Select Students Modal -->
    <div id="selectStudentsModal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-800">Chọn học viên để xuất phiếu</h2>
                <button id="closeSelectModalBtn" class="text-gray-500 hover:text-gray-700">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <div id="selectStudentsList" class="mb-4 max-h-60 overflow-y-auto">
                <!-- Student checkboxes will be added here by JavaScript -->
            </div>
            <div class="flex justify-between mb-4">
                <label class="flex items-center">
                    <input type="checkbox" id="selectAllStudents" class="mr-2">
                    <span class="text-sm">Chọn tất cả</span>
                </label>
                <span id="selectedCount" class="text-sm text-gray-600">0 học viên được chọn</span>
            </div>
            <div class="flex justify-end space-x-3">
                <button id="generateReceiptBtn" class="bg-gray-300 text-gray-800 py-2 px-4 rounded-md hover:bg-gray-400 transition duration-200 disabled:opacity-50" disabled>
                    Xuất phiếu
                </button>
                <button id="cancelSelectBtn" class="bg-red-500 text-white py-2 px-4 rounded-md hover:bg-red-600 transition duration-200">
                    Hủy
                </button>
            </div>
        </div>
    </div>
    <!-- Receipt Modal -->
    <div id="receiptModal" class="modal">
        <div class="modal-content" id="printable-receipt">
            <div class="text-center mb-6">
    <h2 class="text-3xl font-bold text-blue-600">PHIẾU BÁO HỌC PHÍ</h2>
    <h3 class="text-2xl font-semibold text-gray-800 mt-3">THÁNG <span id="receiptMonthDisplay"></span></h3>
</div>

<div class="flex justify-end mb-4 no-print">
    <button id="closeModalBtn" class="text-gray-500 hover:text-gray-700">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
    </button>
</div>
         
            <div class="flex justify-between mb-6">
                <p class="text-sm"><strong>Ngày xuất:</strong> <span id="receiptDate"></span></p>
                <p class="text-sm"><strong>Mã phiếu:</strong> HPDK-<span id="receiptNumber"></span></p>
            </div>
         
         
            <div id="receiptContent">
                <!-- Filled by JavaScript -->
            </div>
    
         
            <div class="mt-6 text-right">
                <p class="text-xl font-bold">TỔNG CỘNG: <span id="receiptTotalFee" class="text-blue-600">0</span> đ</p>
            </div>
         
            <div class="mt-8 flex justify-between">
                <div class="text-center">
                    <p class="font-bold">Người lập phiếu</p>
                    <p class="text-sm text-gray-500 mt-4">(Ký, ghi rõ họ tên)</p>
                </div>
                <div class="text-center">
                    <p class="font-bold">Phụ huynh học viên</p>
                    <p class="text-sm text-gray-500 mt-4">(Ký, ghi rõ họ tên)</p>
                </div>
            </div>
         
            <div class="mt-6 flex justify-center no-print">
                <button id="printReceiptBtn" class="bg-blue-600 text-white py-2 px-6 rounded-md hover:bg-blue-700 transition duration-200">
                    In phiếu
                </button>
            </div>
        </div>
    </div>
<script>
    // Initialize variables
    let currentMonth = new Date().getMonth();
    let currentYear = new Date().getFullYear();
    let students = [];
    let lastSavedState = null;
    let currentEditingStudentId = null;
 
    // DOM Elements
    const studentNameEl = document.getElementById('studentName');
    const studentClassEl = document.getElementById('studentClass');
    const feeRateEl = document.getElementById('feeRate');
    const addStudentBtn = document.getElementById('addStudentBtn');
    const studentSelectEl = document.getElementById('studentSelect');
    const calendarGridEl = document.getElementById('calendarGrid');
    const currentMonthYearEl = document.getElementById('currentMonthYear');
    const prevMonthBtn = document.getElementById('prevMonthBtn');
    const nextMonthBtn = document.getElementById('nextMonthBtn');
    const studentsListEl = document.getElementById('studentsList');
    const totalStudentsEl = document.getElementById('totalStudents');
    const totalFeesEl = document.getElementById('totalFees');
    const clearAllBtn = document.getElementById('clearAllBtn');
    const showReceiptBtn = document.getElementById('showReceiptBtn');
    const receiptModal = document.getElementById('receiptModal');
    const closeModalBtn = document.getElementById('closeModalBtn');
    const printReceiptBtn = document.getElementById('printReceiptBtn');
    const receiptContentEl = document.getElementById('receiptContent');
    const receiptTotalFeeEl = document.getElementById('receiptTotalFee');
    const receiptDateEl = document.getElementById('receiptDate');
    const receiptNumberEl = document.getElementById('receiptNumber');
    const loadFromFileBtn = document.getElementById('loadFromFileBtn');
    const saveToFileBtn = document.getElementById('saveToFileBtn');
    const fileInputEl = document.getElementById('fileInput');
    // Select Students Modal Elements
    const selectStudentsModal = document.getElementById('selectStudentsModal');
    const selectStudentsListEl = document.getElementById('selectStudentsList');
    const selectAllStudentsEl = document.getElementById('selectAllStudents');
    const selectedCountEl = document.getElementById('selectedCount');
    const generateReceiptBtn = document.getElementById('generateReceiptBtn');
    const closeSelectModalBtn = document.getElementById('closeSelectModalBtn');
    const cancelSelectBtn = document.getElementById('cancelSelectBtn');
    // Edit Notes Modal Elements
    const editNotesModal = document.getElementById('editNotesModal');
    const editNotesTextarea = document.getElementById('editNotesTextarea');
    const closeEditNotesBtn = document.getElementById('closeEditNotesBtn');
    const cancelEditNotesBtn = document.getElementById('cancelEditNotesBtn');
    const saveEditNotesBtn = document.getElementById('saveEditNotesBtn');
    // Edit Discount Modal Elements
    const editDiscountModal = document.getElementById('editDiscountModal');
    const editDiscountInput = document.getElementById('editDiscountInput');
    const closeEditDiscountBtn = document.getElementById('closeEditDiscountBtn');
    const cancelEditDiscountBtn = document.getElementById('cancelEditDiscountBtn');
    const saveEditDiscountBtn = document.getElementById('saveEditDiscountBtn');
 
    // Initialize the app
    document.addEventListener('DOMContentLoaded', function() {
        updateMonthYearDisplay();
        generateCalendar();
     
        // Load students from localStorage if available
        const savedStudents = localStorage.getItem('tutoringStudents');
        if (savedStudents) {
            students = JSON.parse(savedStudents);
            // Đảm bảo cấu trúc sessions tương thích (chuyển đổi nếu cần)
            students = students.map(s => ({
                ...s,
                sessions: s.sessions && Array.isArray(s.sessions) ? {} : s.sessions || {} // Chuyển đổi mảng cũ thành object rỗng nếu cần
            }));
            updateStudentSelect();
            renderStudentCards();
            updateSummary();
        }
     
        // Event listeners
        addStudentBtn.addEventListener('click', addStudent);
        prevMonthBtn.addEventListener('click', showPreviousMonth);
        nextMonthBtn.addEventListener('click', showNextMonth);
        studentSelectEl.addEventListener('change', updateAttendanceCheckboxes);
        calendarGridEl.addEventListener('change', handleCalendarChange); // Thay thế event listener cũ
        clearAllBtn.addEventListener('click', clearAllData);
        showReceiptBtn.addEventListener('click', openSelectStudentsModal);
        closeModalBtn.addEventListener('click', closeReceiptModal);
        printReceiptBtn.addEventListener('click', printReceipt);
        loadFromFileBtn.addEventListener('click', () => fileInputEl.click());
        saveToFileBtn.addEventListener('click', saveToFile);
        fileInputEl.addEventListener('change', loadFromFile);
     
        // Select Students Modal Event Listeners
        closeSelectModalBtn.addEventListener('click', closeSelectStudentsModal);
        cancelSelectBtn.addEventListener('click', closeSelectStudentsModal);
        selectAllStudentsEl.addEventListener('change', toggleSelectAll);
        generateReceiptBtn.addEventListener('click', generateReceiptFromSelection);
     
        // Edit Notes Modal Event Listeners
        closeEditNotesBtn.addEventListener('click', closeEditNotesModal);
        cancelEditNotesBtn.addEventListener('click', closeEditNotesModal);
        saveEditNotesBtn.addEventListener('click', saveEditNotes);
     
        // Edit Discount Modal Event Listeners
        closeEditDiscountBtn.addEventListener('click', closeEditDiscountModal);
        cancelEditDiscountBtn.addEventListener('click', closeEditDiscountModal);
        saveEditDiscountBtn.addEventListener('click', saveEditDiscount);
     
        // Close modals when clicking outside
        window.addEventListener('click', function(event) {
            if (event.target === receiptModal) {
                closeReceiptModal();
            }
            if (event.target === selectStudentsModal) {
                closeSelectStudentsModal();
            }
            if (event.target === editNotesModal) {
                closeEditNotesModal();
            }
            if (event.target === editDiscountModal) {
                closeEditDiscountModal();
            }
        });
    });

    // === THÊM MỚI: Hàm lấy key tháng hiện tại ===
    function getCurrentMonthKey() {
        // Trả về định dạng: 12-2025 (Tháng + 1 vì getMonth() trả về 0-11)
        return `${currentMonth + 1}-${currentYear}`; 
    }
 
    // Save students to localStorage
    function saveStudents() {
        localStorage.setItem('tutoringStudents', JSON.stringify(students));
    }
 
    // Add a new student
    function addStudent() {
        const name = studentNameEl.value.trim();
        const className = studentClassEl.value.trim();
        const feeRate = parseInt(feeRateEl.value) || 100000;
     
        if (!name) {
            alert('Vui lòng nhập tên học viên');
            return;
        }
     
        // Check if student already exists
        if (students.some(student => student.name.toLowerCase() === name.toLowerCase())) {
            alert('Học viên đã tồn tại trong hệ thống');
            return;
        }
     
        const student = {
            id: Date.now().toString(),
            name: name,
            class: className,
            feeRate: feeRate,
            discount: 0,
            notes: '',
            sessions: {} // THAY THẾ: Sử dụng object để lưu sessions theo key tháng/năm
        };
     
        students.push(student);
        saveStudents();
        updateStudentSelect();
        renderStudentCards();
        updateSummary();
     
        // Clear inputs
        studentNameEl.value = '';
        studentClassEl.value = '';
        feeRateEl.value = '100000';
    }
 
    // Update student dropdown
    function updateStudentSelect() {
        studentSelectEl.innerHTML = '<option value="">-- Chọn học viên --</option>';
     
        students.forEach(student => {
            const option = document.createElement('option');
            option.value = student.id;
            const classDisplay = student.class ? `${student.class} - ` : '';
            option.textContent = `${student.name} (${classDisplay}${student.feeRate.toLocaleString()} đ/buổi)`;
            studentSelectEl.appendChild(option);
        });
    }
 
    // Generate calendar for the current month
    function generateCalendar() {
        calendarGridEl.innerHTML = '';
     
        // Get first day of the month
        const firstDay = new Date(currentYear, currentMonth, 1);
     
        // Get last day of the month
        const lastDay = new Date(currentYear, currentMonth + 1, 0);
     
        // Get days in month
        const daysInMonth = lastDay.getDate();
     
        // Đổi thứ 2 thành đầu tuần
        let startingDay = firstDay.getDay();
        startingDay = (startingDay === 0) ? 6 : startingDay - 1;
     
        // Add empty cells for days before the first day of the month
        for (let i = 0; i < startingDay; i++) {
            const emptyCell = document.createElement('div');
            emptyCell.className = 'h-8';
            calendarGridEl.appendChild(emptyCell);
        }
     
        // Add day cells
        for (let day = 1; day <= daysInMonth; day++) {
            const date = new Date(currentYear, currentMonth, day);
            const formattedDate = formatDate(date);
         
            const dayCell = document.createElement('div');
            dayCell.className = 'flex flex-col items-center';
         
            // Lấy thứ trong tuần
            const weekdays = ["CN", "T2", "T3", "T4", "T5", "T6", "T7"];
            const weekdayLabel = document.createElement('span');
            weekdayLabel.className = 'text-xs text-gray-500';
            weekdayLabel.textContent = weekdays[date.getDay()];
            // Ngày
            const dayNumber = document.createElement('span');
            dayNumber.className = 'text-sm font-medium';
            dayNumber.textContent = day;
            // Thêm cả thứ + ngày vào cell
            dayCell.appendChild(weekdayLabel);
            dayCell.appendChild(dayNumber);
         
            const checkboxContainer = document.createElement('label');
            checkboxContainer.className = 'checkbox-container mt-1 cursor-pointer';
         
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.className = 'hidden';
            checkbox.dataset.date = formattedDate;
         
            const checkmark = document.createElement('span');
            checkmark.className = 'checkmark block w-6 h-6 border border-gray-300 rounded';
         
            checkboxContainer.appendChild(checkbox);
            checkboxContainer.appendChild(checkmark);
         
            dayCell.appendChild(dayNumber);
            dayCell.appendChild(checkboxContainer);
            calendarGridEl.appendChild(dayCell);
        }
    }

    // === THAY THẾ: Hàm xử lý điểm danh chung cho lịch (chỉ gọi toggleSession) ===
    function handleCalendarChange(event) {
        if (event.target.type === 'checkbox' && event.target.dataset.date) {
            toggleSession(event.target.dataset.date, event.target.checked);
        }
    }
 
    // === THAY THẾ: Toggle session attendance (chỉ cho tháng hiện tại) ===
    function toggleSession(date, attended) {
        const studentId = studentSelectEl.value;
     
        if (!studentId) {
            alert('Vui lòng chọn học viên trước khi điểm danh');
            // Cần reset trạng thái checkbox nếu không có học viên được chọn
            const checkbox = calendarGridEl.querySelector(`input[data-date="${date}"]`);
            if (checkbox) checkbox.checked = !attended; 
            return false;
        }
     
        const student = students.find(s => s.id === studentId);
        const monthKey = getCurrentMonthKey(); // Lấy key tháng hiện tại
     
        // Đảm bảo mảng sessions cho tháng hiện tại tồn tại
        if (!student.sessions[monthKey]) {
            student.sessions[monthKey] = [];
        }
     
        let monthSessions = student.sessions[monthKey];
     
        if (attended) {
            // Thêm buổi học vào mảng của tháng hiện tại
            if (!monthSessions.includes(date)) {
                monthSessions.push(date);
                monthSessions.sort(); // Sắp xếp lại cho đẹp
            }
        } else {
            // Xóa buổi học khỏi mảng của tháng hiện tại
            monthSessions = monthSessions.filter(d => d !== date);
        }
     
        // Cập nhật lại mảng sessions của tháng
        student.sessions[monthKey] = monthSessions;
     
        saveStudents();
        renderStudentCards();
        updateSummary();
        return true;
    }
 
    // === THAY THẾ: Update attendance checkboxes based on selected student (chỉ cho tháng hiện tại) ===
    function updateAttendanceCheckboxes() {
        const studentId = studentSelectEl.value;
        const checkboxes = calendarGridEl.querySelectorAll('input[type="checkbox"]');
        const monthKey = getCurrentMonthKey(); // Lấy key tháng hiện tại
     
        checkboxes.forEach(checkbox => {
            checkbox.checked = false;
         
            if (studentId) {
                const student = students.find(s => s.id === studentId);
                // Lấy sessions của tháng hiện tại
                const monthSessions = student.sessions[monthKey] || []; 
                if (student && monthSessions.includes(checkbox.dataset.date)) {
                    checkbox.checked = true;
                }
            }
        });
    }
 
    // Show previous month
    function showPreviousMonth() {
        currentMonth--;
     
        if (currentMonth < 0) {
            currentMonth = 11;
            currentYear--;
        }
     
        updateMonthYearDisplay();
        generateCalendar();
        updateAttendanceCheckboxes(); // Cập nhật lại trạng thái điểm danh cho tháng mới
        renderStudentCards(); // Cập nhật lại học phí cho tháng mới
        updateSummary();
    }
 
    // Show next month
    function showNextMonth() {
        currentMonth++;
     
        if (currentMonth > 11) {
            currentMonth = 0;
            currentYear++;
        }
     
        updateMonthYearDisplay();
        generateCalendar();
        updateAttendanceCheckboxes(); // Cập nhật lại trạng thái điểm danh cho tháng mới
        renderStudentCards(); // Cập nhật lại học phí cho tháng mới
        updateSummary();
    }
 
    // Update month/year display
    function updateMonthYearDisplay() {
        const months = ['Tháng 1', 'Tháng 2', 'Tháng 3', 'Tháng 4', 'Tháng 5', 'Tháng 6',
                       'Tháng 7', 'Tháng 8', 'Tháng 9', 'Tháng 10', 'Tháng 11', 'Tháng 12'];
        currentMonthYearEl.textContent = `${months[currentMonth]} ${currentYear}`;
    }
 
    // === Cập nhật: Render student cards (chỉ tính học phí tháng hiện tại) ===
    function renderStudentCards() {
        studentsListEl.innerHTML = '';
        
        const monthKey = getCurrentMonthKey();

        students.forEach(student => {
            // Lấy sessions và sessionCount của tháng hiện tại
            const studentSessions = student.sessions[monthKey] || [];
            const sessionCount = studentSessions.length;
            
            const totalFeeBeforeDiscount = sessionCount * student.feeRate;
            const discountAmount = totalFeeBeforeDiscount * (student.discount / 100);
            const totalFee = totalFeeBeforeDiscount - discountAmount;
         
            const card = document.createElement('div');
            card.className = 'fee-card bg-white rounded-lg overflow-hidden shadow-md border-l-4 border-blue-500 hover:border-blue-600';
         
            let notesHtml = '';
            if (student.notes && student.notes.trim()) {
                notesHtml = `
                    <div class="mt-3 p-2 bg-yellow-50 border border-yellow-200 rounded text-sm text-gray-700">
                        <strong>Ghi chú:</strong> ${student.notes}
                    </div>
                `;
            }
         
            const buttonText = student.notes && student.notes.trim() ? 'Chỉnh sửa ghi chú' : 'Thêm ghi chú';
            const classDisplay = student.class ? `<p class="text-sm text-gray-600 mt-1">Lớp: ${student.class}</p>` : '';
            const discountDisplay = student.discount > 0 ? `<div class="flex justify-between mt-1"><span class="text-gray-600 text-xs">Giảm giá:</span><span class="font-medium text-xs text-red-600">${student.discount}%</span></div>` : '';
         
            card.innerHTML = `
                <div class="p-4">
                    <div class="flex justify-between items-start mb-3">
                        <h3 class="font-bold text-lg text-gray-800">${student.name}</h3>
                        <div class="flex flex-col space-y-1">
                            <div class="flex space-x-1">
                                <button class="edit-notes-btn bg-yellow-500 text-white px-2 py-1 rounded text-xs hover:bg-yellow-600 transition duration-200" data-id="${student.id}">
                                    ${buttonText}
                                </button>
                                ${student.notes && student.notes.trim() ? `<button class="delete-notes-btn bg-red-400 text-white px-2 py-1 rounded text-xs hover:bg-red-500 transition duration-200" data-id="${student.id}">Xóa ghi chú</button>` : ''}
                            </div>
                            <div class="flex space-x-1">
                                <button class="edit-discount-btn bg-green-500 text-white px-2 py-1 rounded text-xs hover:bg-green-600 transition duration-200" data-id="${student.id}">
                                    Chỉnh sửa giảm giá
                                </button>
                                <button class="delete-student-btn text-red-500 hover:text-red-700 text-xs" data-id="${student.id}">
                                    Xóa
                                </button>
                            </div>
                        </div>
                    </div>
                    ${classDisplay}
                    <div class="space-y-2">
                        <div class="flex justify-between">
                            <span class="text-gray-600">Số buổi (${monthKey}):</span>
                            <span class="font-medium">${sessionCount}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Đơn giá:</span>
                            <span class="font-medium">${student.feeRate.toLocaleString()} đ/buổi</span>
                        </div>
                        ${discountDisplay}
                        <div class="flex justify-between">
                            <span class="text-gray-600">Học phí:</span>
                            <span class="font-bold text-blue-600">${totalFee.toLocaleString()} đ</span>
                        </div>
                    </div>
                    ${notesHtml}
                </div>
            `;
         
            studentsListEl.appendChild(card);
        });
     
        // Add event listeners to delete buttons
        document.querySelectorAll('.delete-student-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                deleteStudent(this.dataset.id);
            });
        });
        // Add event listeners to edit notes buttons
        document.querySelectorAll('.edit-notes-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                editNotes(this.dataset.id);
            });
        });
        // Add event listeners to delete notes buttons
        document.querySelectorAll('.delete-notes-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                deleteNotes(this.dataset.id);
            });
        });
        // Add event listeners to edit discount buttons
        document.querySelectorAll('.edit-discount-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                editDiscount(this.dataset.id);
            });
        });
    }
 
    // Edit notes for a student
    function editNotes(studentId) {
        currentEditingStudentId = studentId;
        const student = students.find(s => s.id === studentId);
        if (student) {
            editNotesTextarea.value = student.notes || '';
            editNotesModal.style.display = 'block';
            document.body.style.overflow = 'hidden';
        }
    }
    // Delete notes for a student
    function deleteNotes(studentId) {
        if (confirm('Bạn có chắc muốn xóa ghi chú của học viên này?')) {
            const student = students.find(s => s.id === studentId);
            if (student) {
                student.notes = '';
                saveStudents();
                renderStudentCards();
            }
        }
    }
    // Save edited notes
    function saveEditNotes() {
        if (currentEditingStudentId) {
            const student = students.find(s => s.id === currentEditingStudentId);
            if (student) {
                student.notes = editNotesTextarea.value.trim();
                saveStudents();
                renderStudentCards();
                closeEditNotesModal();
            }
        }
    }
    // Close Edit Notes Modal
    function closeEditNotesModal() {
        editNotesModal.style.display = 'none';
        document.body.style.overflow = 'auto';
        currentEditingStudentId = null;
        editNotesTextarea.value = '';
    }
    // Edit discount for a student
    function editDiscount(studentId) {
        currentEditingStudentId = studentId;
        const student = students.find(s => s.id === studentId);
        if (student) {
            editDiscountInput.value = student.discount || 0;
            editDiscountModal.style.display = 'block';
            document.body.style.overflow = 'hidden';
        }
    }
    // Save edited discount
    function saveEditDiscount() {
        if (currentEditingStudentId) {
            const student = students.find(s => s.id === currentEditingStudentId);
            if (student) {
                const discountValue = parseFloat(editDiscountInput.value) || 0;
                student.discount = Math.max(0, Math.min(100, discountValue)); // Clamp between 0-100
                saveStudents();
                renderStudentCards();
                updateSummary();
                closeEditDiscountModal();
            }
        }
    }
    // Close Edit Discount Modal
    function closeEditDiscountModal() {
        editDiscountModal.style.display = 'none';
        document.body.style.overflow = 'auto';
        currentEditingStudentId = null;
        editDiscountInput.value = '';
    }
 
    // Delete a student
    function deleteStudent(id) {
        if (confirm('Bạn có chắc muốn xóa học viên này?')) {
            students = students.filter(student => student.id !== id);
            saveStudents();
         
            if (studentSelectEl.value === id) {
                studentSelectEl.value = '';
            }
         
            updateStudentSelect();
            renderStudentCards();
            updateSummary();
            updateAttendanceCheckboxes();
        }
    }
 
    // Clear all data
    function clearAllData() {
        if (confirm('Bạn có chắc muốn xóa tất cả dữ liệu?')) {
            students = [];
            localStorage.removeItem('tutoringStudents');
            updateStudentSelect();
            renderStudentCards();
            updateSummary();
            studentSelectEl.value = '';
            updateAttendanceCheckboxes();
        }
    }
 
    // === Cập nhật: Update summary information (chỉ tính tổng học phí tháng hiện tại) ===
    function updateSummary() {
        let totalFees = 0;
        const monthKey = getCurrentMonthKey();
     
        students.forEach(student => {
            // Lấy sessions và sessionCount của tháng hiện tại
            const studentSessions = student.sessions[monthKey] || [];
            const sessionCount = studentSessions.length;
            
            const totalFeeBeforeDiscount = sessionCount * student.feeRate;
            const discountAmount = totalFeeBeforeDiscount * (student.discount / 100);
            totalFees += totalFeeBeforeDiscount - discountAmount;
        });
     
        totalStudentsEl.textContent = students.length;
        totalFeesEl.textContent = totalFees.toLocaleString();
    }
 
    // Format date as YYYY-MM-DD
    function formatDate(date) {
        const d = new Date(date);
        let month = '' + (d.getMonth() + 1);
        let day = '' + d.getDate();
        const year = d.getFullYear();
     
        if (month.length < 2) month = '0' + month;
        if (day.length < 2) day = '0' + day;
     
        return [year, month, day].join('-');
    }
 
    // Format date display in Vietnamese format
    function formatDisplayDate(dateStr) {
        const date = new Date(dateStr);
        const day = date.getDate();
        const month = date.getMonth() + 1;
        const year = date.getFullYear();
        return `${day}/${month}/${year}`;
    }
    // Open Select Students Modal
    function openSelectStudentsModal() {
        if (students.length === 0) {
            alert('Không có học viên nào để xuất phiếu');
            return;
        }
        populateSelectStudentsList();
        selectStudentsModal.style.display = 'block';
        document.body.style.overflow = 'hidden';
    }
    // Close Select Students Modal
    function closeSelectStudentsModal() {
        selectStudentsModal.style.display = 'none';
        document.body.style.overflow = 'auto';
        // Reset selections
        selectStudentsListEl.innerHTML = '';
        selectAllStudentsEl.checked = false;
        selectAllStudentsEl.indeterminate = false; // Thêm reset indeterminate
        updateGenerateButton();
    }
    // Populate Select Students List
    function populateSelectStudentsList() {
        selectStudentsListEl.innerHTML = '';
        const monthKey = getCurrentMonthKey(); // Lấy key tháng hiện tại

        students.forEach(student => {
            // Lấy sessions và sessionCount của tháng hiện tại
            const studentSessions = student.sessions[monthKey] || [];
            const sessionCount = studentSessions.length;
            
            const totalFeeBeforeDiscount = sessionCount * student.feeRate;
            const discountAmount = totalFeeBeforeDiscount * (student.discount / 100);
            const totalFee = totalFeeBeforeDiscount - discountAmount;
            
            const div = document.createElement('div');
            div.className = 'flex items-center p-2 border-b';
            const classDisplay = student.class ? `${student.class} - ` : '';
            const notesInfo = student.notes && student.notes.trim() ? ` (Có ghi chú: "${student.notes.substring(0, 30)}${student.notes.length > 30 ? '...' : ''}")` : ' (Không có ghi chú)';
            const discountInfo = student.discount > 0 ? ` (Giảm ${student.discount}%)` : '';
            
            div.innerHTML = `
                <input type="checkbox" class="mr-2 student-select-checkbox" data-id="${student.id}" id="select-${student.id}">
                <label for="select-${student.id}" class="flex-1 cursor-pointer text-sm">
                    ${student.name} (${classDisplay}${sessionCount} buổi (${totalFee.toLocaleString()} đ)${notesInfo}${discountInfo}
                </label>
                <input type="checkbox" class="ml-3 include-notes-checkbox" data-id="${student.id}" id="include-${student.id}" ${student.notes && student.notes.trim() ? '' : 'disabled'}>
                <label for="include-${student.id}" class="ml-1 text-xs text-gray-500 cursor-pointer">Chèn ghi chú</label>
            `;
            selectStudentsListEl.appendChild(div);
        });
        // Add event listeners to student checkboxes
        document.querySelectorAll('.student-select-checkbox').forEach(checkbox => {
            checkbox.addEventListener('change', updateGenerateButton);
        });
        // Add event listeners to include notes checkboxes (only if student selected)
        document.querySelectorAll('.include-notes-checkbox').forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                // Optional: can add logic here if needed
            });
            // Disable if no notes
            const studentId = checkbox.dataset.id;
            const student = students.find(s => s.id === studentId);
            if (!student.notes || !student.notes.trim()) {
                checkbox.disabled = true;
                checkbox.checked = false;
            } else {
                checkbox.checked = true; // Default to checked if has notes
            }
        });
    }
    // Toggle Select All
    function toggleSelectAll() {
        const checkboxes = document.querySelectorAll('.student-select-checkbox');
        checkboxes.forEach(checkbox => {
            checkbox.checked = selectAllStudentsEl.checked;
            // If selecting all, set include notes based on whether they have notes
            const includeCheckbox = document.querySelector(`.include-notes-checkbox[data-id="${checkbox.dataset.id}"]`);
            if (includeCheckbox) {
                const student = students.find(s => s.id === checkbox.dataset.id);
                // Chỉ bật nếu có ghi chú và đang chọn tất cả
                includeCheckbox.checked = selectAllStudentsEl.checked && !!(student.notes && student.notes.trim());
            }
        });
        updateGenerateButton();
    }
    // Update Generate Button State
    function updateGenerateButton() {
        const checkboxes = document.querySelectorAll('.student-select-checkbox:checked');
        const count = checkboxes.length;
        selectedCountEl.textContent = `${count} học viên được chọn`;
        generateReceiptBtn.disabled = count === 0;
        
        // Cập nhật trạng thái của checkbox "Chọn tất cả"
        if (students.length > 0) {
            if (count === students.length) {
                selectAllStudentsEl.checked = true;
                selectAllStudentsEl.indeterminate = false;
            } else if (count === 0) {
                selectAllStudentsEl.checked = false;
                selectAllStudentsEl.indeterminate = false;
            } else {
                selectAllStudentsEl.checked = false;
                selectAllStudentsEl.indeterminate = true;
            }
        }
    }
    // Generate Receipt from Selection
    function generateReceiptFromSelection() {
        const selectedIds = Array.from(document.querySelectorAll('.student-select-checkbox:checked')).map(cb => cb.dataset.id);
        const selectedStudents = students.filter(s => selectedIds.includes(s.id));
        if (selectedStudents.length === 0) return;
        // Collect include notes flags
        const includeNotesMap = {};
        selectedIds.forEach(id => {
            const includeCheckbox = document.querySelector(`.include-notes-checkbox[data-id="${id}"]`);
            includeNotesMap[id] = includeCheckbox ? includeCheckbox.checked : false;
        });
        closeSelectStudentsModal();
        updateReceiptContent(selectedStudents, includeNotesMap);
        openReceiptModal();
    }
    // Open Receipt Modal
    function openReceiptModal() {
        receiptModal.style.display = 'block';
        document.body.style.overflow = 'hidden';
    }
    // Close Receipt Modal
    function closeReceiptModal() {
        receiptModal.style.display = 'none';
        document.body.style.overflow = 'auto';
    }
 
    // Print receipt
    function printReceipt() {
        window.print();
    }
 
    // === Cập nhật: Update Receipt Content (chỉ hiển thị sessions và tính phí tháng hiện tại) ===
    function updateReceiptContent(selectedStudents = students, includeNotesMap = {}) {
        receiptContentEl.innerHTML = '';
        const today = new Date();
        receiptDateEl.textContent = today.toLocaleDateString('vi-VN');
        
        const monthKey = getCurrentMonthKey(); // Lấy key tháng hiện tại

        // Hiển thị tháng đang tính (dùng tháng hiện tại của lịch, không phải tháng xuất phiếu)
        const monthsDisplay = ['1', '2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12'];
        document.getElementById('receiptMonthDisplay').textContent = 
            `${monthsDisplay[currentMonth]} / ${currentYear}`;
            
        const month = String(today.getMonth() + 1).padStart(2, '0');
        const year = String(today.getFullYear()).slice(-2);
        
        // Tạo snapshot hiện tại (danh sách học viên + buổi học)
        // Lưu ý: snapshot này chỉ quan tâm đến student.id + sessions của tháng hiện tại
        const currentState = JSON.stringify(selectedStudents.map(s => ({
            id: s.id, 
            sessions: s.sessions[monthKey] || [], 
            includeNotes: includeNotesMap[s.id]
        })));
        
        // Nếu khác lần trước thì mới +1
        let receiptCounter = localStorage.getItem(`receiptCounter-${month}${year}`) || 0;
        if (lastSavedState !== currentState) {
            receiptCounter = parseInt(receiptCounter) + 1;
            localStorage.setItem(`receiptCounter-${month}${year}`, receiptCounter);
            lastSavedState = currentState; // cập nhật trạng thái
        }
        const serial = String(receiptCounter).padStart(5, '0');
        receiptNumberEl.textContent = `${month}${year}-${serial}`;
        // --- phần render học viên giữ nguyên ---
        let totalFee = 0;
        selectedStudents.forEach(student => {
            // Lấy sessions và sessionCount của tháng hiện tại
            const studentSessions = student.sessions[monthKey] || [];
            const sessionCount = studentSessions.length;
            
            const totalFeeBeforeDiscount = sessionCount * student.feeRate;
            const discountAmount = totalFeeBeforeDiscount * (student.discount / 100);
            const studentTotal = totalFeeBeforeDiscount - discountAmount;
            totalFee += studentTotal;
            
            const studentSection = document.createElement('div');
            studentSection.className = "mb-6 p-4 border rounded-lg bg-gray-50";
            const header = document.createElement('h3');
            header.className = "font-bold text-lg text-blue-600 mb-2";
            const classDisplay = student.class ? ` - Lớp ${student.class}` : '';
            header.textContent = `Học viên: ${student.name}${classDisplay}`;
            studentSection.appendChild(header);
            const row = document.createElement('div');
            row.className = 'receipt-row receipt-header';
            row.innerHTML = `
                <div>Tên học viên</div>
                <div>Số buổi</div>
                <div>Đơn giá</div>
                <div>Thành tiền</div>
            `;
            studentSection.appendChild(row);
            const dataRow = document.createElement('div');
            dataRow.className = 'receipt-row';
            dataRow.innerHTML = `
                <div>${student.name}</div>
                <div>${sessionCount}</div>
                <div>${student.feeRate.toLocaleString()} đ</div>
                <div>${studentTotal.toLocaleString()} đ</div>
            `;
            studentSection.appendChild(dataRow);
            if (student.discount > 0) {
                const discountRow = document.createElement('div');
                discountRow.className = 'receipt-row text-sm text-red-600';
                discountRow.innerHTML = `
                    <div></div>
                    <div></div>
                    <div>Giảm giá: ${student.discount}%</div>
                    <div>-${discountAmount.toLocaleString()} đ</div>
                `;
                studentSection.appendChild(discountRow);
            }
            if (studentSessions.length > 0) {
                const detailTitle = document.createElement('p');
                detailTitle.className = "font-medium mt-4";
                detailTitle.textContent = "Chi tiết buổi học:";
                studentSection.appendChild(detailTitle);
                const sessionGrid = document.createElement('div');
                sessionGrid.className = "session-grid mt-2";
                
                // Dùng studentSessions của tháng hiện tại
                studentSessions.forEach(session => {
                    const sessionItem = document.createElement('div');
                    sessionItem.className = 'session-item';
                    sessionItem.textContent = formatDisplayDate(session);
                    sessionGrid.appendChild(sessionItem);
                });
                studentSection.appendChild(sessionGrid);
            }
            // Add notes if included
            const includeNotes = includeNotesMap[student.id] || false;
            if (includeNotes && student.notes && student.notes.trim()) {
                const notesSection = document.createElement('div');
                notesSection.className = "notes-section";

                const notesParagraph = document.createElement('p');
                notesParagraph.innerHTML = '<strong>Ghi chú:</strong> ' + 
                    student.notes
                        .replace(/\n/g, '<br>')  // Chuyển \n thành <br>
                        .replace(/\r/g, '')      // Xử lý trường hợp \r\n (Windows)
                        .trim();

                notesSection.appendChild(notesParagraph);
                studentSection.appendChild(notesSection);
            }
            receiptContentEl.appendChild(studentSection);
        });
        receiptTotalFeeEl.textContent = totalFee.toLocaleString();
    }
 
    // Save data to file
    function saveToFile() {
        if (students.length === 0) {
            alert('Không có dữ liệu nào để lưu');
            return;
        }
     
        const data = {
            students: students,
            lastUpdated: new Date().toISOString()
        };
     
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
     
        const a = document.createElement('a');
        a.href = url;
        a.download = `hocphi_${new Date().toISOString().slice(0,10)}.json`;
        a.click();
     
        URL.revokeObjectURL(url);
    }
 
    // Load data from file
    function loadFromFile(event) {
        const file = event.target.files[0];
        if (!file) return;
     
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const data = JSON.parse(e.target.result);
                if (data.students && Array.isArray(data.students)) {
                    students = data.students.map(s => ({
                        ...s,
                        class: s.class || '',
                        discount: s.discount || 0,
                        notes: s.notes || '', // Ensure notes field exists
                        // Đảm bảo sessions là object cho cấu trúc mới
                        sessions: s.sessions && Array.isArray(s.sessions) ? {} : s.sessions || {}
                    }));
                    saveStudents();
                    updateStudentSelect();
                    renderStudentCards();
                    updateSummary();
                    alert('Đã tải dữ liệu thành công!');
                } else {
                    throw new Error('Định dạng file không hợp lệ');
                }
            } catch (error) {
                alert('Lỗi khi đọc file: ' + error.message);
            }
        };
        reader.readAsText(file);
        fileInputEl.value = ''; // Reset file input
    }
</script>
</body>
</html>